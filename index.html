<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>在管 × SMILE 在庫比較</title>

<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<style>
body { font-family: Arial; padding: 20px; }
table { border-collapse: collapse; margin-top: 20px; width: 100%; }
th, td { border: 1px solid #ccc; padding: 6px 8px; text-align: center; }
th { background: #f0f0f0; }

.sub { font-size: 0.5em; color: #666; }

.gray { background: #eee; color: #999; }

.need-red { background: #ffe5e5; font-weight: bold; }
.need-orange { background: #fff3cd; font-weight: bold; }

.smile-row { background-color: #e6f2ff; }   /* 青：SMILE */
.zakan-row { background-color: #fff9db; }   /* 黄：在管 */

.diff-plus { background-color: #e6ffed; font-weight: bold; }
.diff-minus { background-color: #ffecec; font-weight: bold; }
</style>
</head>

<body>

<h2>在管システム × SMILE 在庫比較</h2>

<p>
  在管CSV：
  <input type="file" id="csvFile" accept=".csv">
  &nbsp;&nbsp;
  SMILE CSV：
  <input type="file" id="smileFile" accept=".csv">
</p>

<table id="result">
<thead>
<tr>
  <th>商品名</th>

  <th>東京良品<br><span class="sub">在管システム</span></th>
  <th>東京倉庫<br><span class="sub">SMILE</span></th>
  <th>差分<br><span class="sub">SMILE-良品</span></th>
  <th>東京空箱<br><span class="sub">在管システム</span></th>

  <th>大阪良品<br><span class="sub">在管システム</span></th>
  <th>大阪倉庫<br><span class="sub">SMILE</span></th>
  <th>差分<br><span class="sub">SMILE-良品</span></th>
  <th>大阪空箱<br><span class="sub">在管システム</span></th>

  <th>名古屋良品<br><span class="sub">在管システム</span></th>
  <th>名古屋名港<br><span class="sub">SMILE</span></th>
  <th>差分<br><span class="sub">SMILE-良品</span></th>
  <th>名古屋空箱<br><span class="sub">在管システム</span></th>

  <th>福岡良品<br><span class="sub">在管システム</span></th>
  <th>福岡倉庫<br><span class="sub">SMILE</span></th>
  <th>差分<br><span class="sub">SMILE-良品</span></th>
  <th>福岡空箱<br><span class="sub">在管システム</span></th>

  <th>北海道良品<br><span class="sub">在管システム</span></th>
  <th>北海道倉庫<br><span class="sub">SMILE</span></th>
  <th>差分<br><span class="sub">SMILE-良品</span></th>
  <th>北海道空箱<br><span class="sub">在管システム</span></th>

  <th>龍ヶ崎良品<br><span class="sub">在管システム</span></th>
  <th>龍ヶ崎倉庫<br><span class="sub">SMILE</span></th>
  <th>差分<br><span class="sub">SMILE-良品</span></th>
  <th>龍ヶ崎空箱<br><span class="sub">在管システム</span></th>

  <th>仙台倉庫<br><span class="sub">SMILE</span></th>
</tr>
</thead>
<tbody></tbody>
</table>

<script>
const csvFile = document.getElementById("csvFile");
const smileFile = document.getElementById("smileFile");
const tbody = document.querySelector("#result tbody");

const norm = s => (s || "").replace(/[\s　]/g, "");

let smileMap = {};

/* ===== SMILE CSV（UTF-8） ===== */
smileFile.addEventListener("change", e => {
  const reader = new FileReader();
  reader.onload = () => parseSmileCSV(reader.result);
  reader.readAsText(e.target.files[0], "UTF-8");
});

function parseSmileCSV(text) {
  smileMap = {};

  const delimiter = text.includes("\t") ? "\t" : ",";
  const rows = text.trim().split(/\r?\n/).map(r => r.split(delimiter));

  const headers = rows[0];
  const idx = {};
  headers.forEach((h, i) => idx[norm(h)] = i);

  for (let i = 1; i < rows.length; i++) {
    const r = rows[i];
    const name = r[idx[norm("商品名")]];
    if (!name) continue;

    smileMap[name] = {
      東京: Number(r[idx[norm("東京倉庫")]] || 0),
      大阪: Number(r[idx[norm("大阪倉庫")]] || 0),
      名古屋: Number(r[idx[norm("名古屋名港")]] || 0),
      福岡: Number(r[idx[norm("福岡倉庫")]] || 0),
      北海道: Number(r[idx[norm("北海道倉庫")]] || 0),
      仙台: Number(r[idx[norm("仙台倉庫")]] || 0),
      龍ヶ崎: Number(r[idx[norm("龍ヶ崎倉庫")]] || 0)
    };
  }
}

/* ===== 在管 CSV（Shift_JIS） ===== */
csvFile.addEventListener("change", e => {
  const reader = new FileReader();
  reader.onload = () => parseMainCSV(reader.result);
  reader.readAsText(e.target.files[0], "Shift_JIS");
});

function parseMainCSV(text) {
  tbody.innerHTML = "";

  const delimiter = text.includes("\t") ? "\t" : ",";
  const rows = text.trim().split(/\r?\n/).map(r => r.split(delimiter));

  const headers = rows[0];
  const idx = {};
  headers.forEach((h, i) => idx[norm(h)] = i);

  const warehouses = [
    { key:"東京", good:"東京良品", box:"東京空き段ボール" },
    { key:"大阪", good:"新大阪良品", box:"新大阪空き段ボール" },
    { key:"名古屋", good:"新名古屋良品", box:"新名古屋空き段ボール" },
    { key:"福岡", good:"福岡良品", box:"福岡空き段ボール" },
    { key:"北海道", good:"北海道良品", box:"北海道空き段ボール" },
    { key:"龍ヶ崎", good:"龍ケ崎良品", box:"龍ケ崎空き段ボール" }
  ];

  for (let i = 1; i < rows.length; i++) {
    const r = rows[i];
    const name = r[idx[norm("商品名")]];
    if (!name) continue;

    let hasSmile = false;
    let hasZakan = false;
    let cells = "";

    warehouses.forEach(w => {
      const good = Number(r[idx[norm(w.good)]] || 0);
      const box  = Number(r[idx[norm(w.box)]] || 0);

      if (good !== 0 || box !== 0) hasZakan = true;

      const smile = smileMap[name]?.[w.key];
      if (smile !== undefined) hasSmile = true;

      let diff = "", diffCls = "";
      if (smile !== undefined) {
        diff = smile - good;
        diffCls = diff > 0 ? "diff-plus" : diff < 0 ? "diff-minus" : "";
      }

      let boxCls = box <= 0 ? "need-red" : box === 1 ? "need-orange" : "";

      cells += `
        <td>${good}</td>
        <td>${smile !== undefined ? smile : "―"}</td>
        <td class="${diffCls}">${diff !== "" ? diff : "―"}</td>
        <td class="${boxCls}">${box}</td>
      `;
    });

    const sendaiSmile = smileMap[name]?.仙台;
    if (sendaiSmile !== undefined) hasSmile = true;

    cells += `<td>${sendaiSmile !== undefined ? sendaiSmile : "―"}</td>`;

    const tr = document.createElement("tr");
    if (hasSmile) {
      tr.classList.add("smile-row");
    } else if (hasZakan) {
      tr.classList.add("zakan-row");
    }

    tr.innerHTML = `<td>${name}</td>${cells}`;
    tbody.appendChild(tr);
  }
}
</script>

</body>
</html>
