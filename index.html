<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>空箱発注チェック</title>

<style>
body { font-family: Arial; padding: 20px; }
table { border-collapse: collapse; margin-top: 20px; width: 100%; }
th, td { border: 1px solid #ccc; padding: 6px 8px; text-align: center; }
th { background: #f0f0f0; }

.gray { background: #eee; color: #999; }
.good-alert { background: #fff3cd; font-weight: bold; }
.replace { background: #cce5ff; font-weight: bold; }
.need-red { background: #ffe5e5; font-weight: bold; }
.need-orange { background: #fff3cd; font-weight: bold; }
</style>
</head>

<body>

<h2>空箱発注チェック</h2>

良品判定値：
<input type="number" id="goodLimit" value="5" min="0">

<input type="file" id="csvFile" accept=".csv">

<button id="exportAllCsv" style="margin-left:10px;">
  空箱0商品 CSV出力（全倉庫）
</button>

<table id="result">
<thead>
<tr>
  <th>在庫少</th>
  <th>空箱＋不良あり</th>
  <th>商品名</th>

  <th>東京良品</th><th>東京空箱</th>
  <th>大阪良品</th><th>大阪空箱</th>
  <th>名古屋良品</th><th>名古屋空箱</th>
  <th>福岡良品</th><th>福岡空箱</th>
  <th>龍ヶ崎良品</th><th>龍ヶ崎空箱</th>
  <th>北海道良品</th><th>北海道空箱</th>
</tr>
</thead>
<tbody></tbody>
</table>

<script>
const fileInput = document.getElementById("csvFile");
const tbody = document.querySelector("#result tbody");
const goodLimitInput = document.getElementById("goodLimit");
const exportBtn = document.getElementById("exportAllCsv");

const norm = s => (s || "").replace(/[\s　]/g,"");

let productBoxMap = {};

fileInput.addEventListener("change", e => {
  const reader = new FileReader();
  reader.onload = () => parseCSV(reader.result);
  reader.readAsText(e.target.files[0], "Shift_JIS");
});

exportBtn.onclick = () => exportAllWarehouseCSV();

function parseCSV(text) {
  tbody.innerHTML = "";
  productBoxMap = {};

  const delimiter = text.includes("\t") ? "\t" : ",";
  const rows = text.trim().split(/\r?\n/).map(r => r.split(delimiter));
  const headers = rows[0];

  const idx = {};
  headers.forEach((h,i)=>idx[norm(h)] = i);

  const v = (r,n) => Number(r[idx[norm(n)]] || 0);
  const goodLimit = Number(goodLimitInput.value);

  const warehouses = [
    { key:"東京", mark:"東", good:"東京良品", box:"東京空き段ボール",
      bad:["東京入庫破損","東京返品（JP都合）","不具合品（東京倉庫）","倉庫内破損（東京倉庫）"]},
    { key:"大阪", mark:"大", good:"新大阪良品", box:"新大阪空き段ボール",
      bad:["新大阪入庫破損","新大阪代替戻（返品）","不具合品（新大阪倉庫）","倉庫内破損（新大阪倉庫）"]},
    { key:"名古屋", mark:"名", good:"新名古屋良品", box:"新名古屋空き段ボール",
      bad:["新名古屋入庫破損","新名古屋返品（JP都合）","不具合品（新名古屋倉庫）","倉庫内破損（新名古屋倉庫）"]},
    { key:"福岡", mark:"福", good:"福岡良品", box:"福岡空き段ボール",
      bad:["福岡入庫破損","福岡返品（JP都合）","不具合品（福岡倉庫）","倉庫内破損（福岡倉庫）"]},
    { key:"龍ヶ崎", mark:"龍", good:"龍ケ崎良品", box:"龍ケ崎空き段ボール",
      bad:["龍ケ崎入庫破損","龍ケ崎返品","不具合品（龍ケ崎倉庫）","倉庫内破損（龍ケ崎倉庫）"]},
    { key:"北海道", mark:"北", good:"北海道良品", box:"北海道空き段ボール",
      bad:["北海道入庫破損","北海道返品（JP都合）","不具合品（北海道倉庫）","倉庫内破損（北海道倉庫）"]}
  ];

  for (let i=1;i<rows.length;i++){
    const r = rows[i];
    const name = r[idx[norm("商品名")]];
    if (!name) continue;

    const areaText = (r[r.length-1] || "").trim();

    const goodAlerts = [];
    let needReplace = false;

    if (!productBoxMap[name]) productBoxMap[name] = {};

    const cells = warehouses.map(w => {
      const enabled = areaText.includes(w.mark);

      if (!enabled) {
        return `<td class="gray">―</td><td class="gray">―</td>`;
      }

      const good = v(r, w.good);
      const box  = v(r, w.box);
      const badSum = w.bad.reduce((s,b)=>s+v(r,b),0);

      productBoxMap[name][w.key] = box;

      if (good <= goodLimit) goodAlerts.push(`${w.key}:${good}`);
      if (box >= 1 && badSum >= 1) needReplace = true;

      let boxCls = "";
      if (box <= 0) boxCls = "need-red";
      else if (box === 1) boxCls = "need-orange";

      return `<td>${good}</td><td class="${boxCls}">${box}</td>`;
    });

    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td class="good-alert">${goodAlerts.join(" / ")}</td>
      <td class="${needReplace ? "replace" : ""}">${needReplace ? "空箱＋不良あり" : ""}</td>
      <td>${name}</td>
      ${cells.join("")}
    `;
    tbody.appendChild(tr);
  }

  window._warehouses = warehouses;
}

function exportAllWarehouseCSV() {
  if (!window._warehouses) return;

  const warehouses = window._warehouses;
  let csv = ["商品名", ...warehouses.map(w=>w.key)].join(",") + "\n";

  Object.entries(productBoxMap).forEach(([name, boxes]) => {
    const values = warehouses.map(w =>
      boxes[w.key] === undefined ? "" : boxes[w.key]
    );

    const hasZero = values.some(v => v === 0);
    const allSafe = values.filter(v=>v!=="").every(v => v >= 2);

    if (hasZero && !allSafe) {
      csv += [name, ...values].join(",") + "\n";
    }
  });

  downloadCSV(csv, "空箱0商品一覧_全倉庫.csv");
}

function downloadCSV(csv, filename) {
  const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = filename;
  a.click();
  URL.revokeObjectURL(url);
}
</script>

</body>
</html>
