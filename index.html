<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>空箱発注チェック</title>

<style>
body {
  font-family: Arial, sans-serif;
  padding: 20px;
}

table {
  border-collapse: collapse;
  margin-top: 20px;
  width: 100%;
}

th, td {
  border: 1px solid #ccc;
  padding: 6px 8px;
  text-align: center;
}

th {
  background: #f0f0f0;
}

.need-red {
  background: #ffe5e5;
  color: #b00000;
  font-weight: bold;
}

.need-orange {
  background: #fff3cd;
  color: #8a6d3b;
  font-weight: bold;
}

.gray {
  background: #eee;
  color: #999;
}
</style>
</head>

<body>

<h2>空箱発注チェック</h2>

<input type="file" id="csvFile" accept=".csv">

<table id="result">
  <thead>
    <tr>
      <th>商品名</th>
      <th>東京</th>
      <th>大阪</th>
      <th>名古屋</th>
      <th>福岡</th>
      <th>龍ヶ崎</th>
      <th>北海道</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<script>
const fileInput = document.getElementById("csvFile");
const tbody = document.querySelector("#result tbody");

// ヘッダー正規化
const norm = s => s.replace(/\s/g, "").trim();

// CSV読み込み
fileInput.addEventListener("change", e => {
  const file = e.target.files[0];
  if (!file) return;

  const reader = new FileReader();
  reader.onload = () => parseCSV(reader.result);
  reader.readAsText(file, "Shift_JIS");
});

function parseCSV(text) {
  tbody.innerHTML = "";

  const rows = text.trim().split(/\r?\n/).map(r => r.split(","));
  const headers = rows[0];

  const idx = {};
  headers.forEach((h, i) => idx[norm(h)] = i);

  const v = (row, name) => {
    const i = idx[norm(name)];
    return i === undefined ? 0 : Number(row[i] || 0);
  };

  for (let i = 1; i < rows.length; i++) {
    const r = rows[i];
    const name = r[idx[norm("商品名")]];
    if (!name) continue;

    // ===== 一番右の列（倉庫指定文字）=====
    const areaText = r[r.length - 1] || "";

    const useTokyo     = areaText.includes("東");
    const useOsaka     = areaText.includes("大");
    const useNagoya    = areaText.includes("名");
    const useFukuoka   = areaText.includes("福");
    const useHokkaido  = areaText.includes("北");
    const useRyugasaki = areaText.includes("龍");

    // ===== 倉庫別計算（有効な倉庫のみ）=====
    const tokyo = useTokyo ? 
      v(r,"東京空き段ボール") -
      (
        v(r,"東京入庫破損") +
        v(r,"東京返品（JP都合）") +
        v(r,"東京代替戻り（ダイワ都合）") +
        v(r,"不具合品（東京倉庫）") +
        v(r,"倉庫内破損（東京倉庫）")
      ) : null;

    const osaka = useOsaka ?
      v(r,"新大阪空き段ボール") -
      (
        v(r,"新大阪入庫破損") +
        v(r,"新大阪代替戻（返品）") +
        v(r,"不具合品（新大阪倉庫）") +
        v(r,"倉庫内破損（新大阪倉庫）")
      ) : null;

    const nagoya = useNagoya ?
      v(r,"新名古屋空き段ボール") -
      (
        v(r,"新名古屋入庫破損") +
        v(r,"新名古屋返品（JP都合）") +
        v(r,"新名古屋代替戻り（名港都合）") +
        v(r,"不具合品（新名古屋倉庫）") +
        v(r,"倉庫内破損（新名古屋倉庫）")
      ) : null;

    const fukuoka = useFukuoka ?
      v(r,"福岡空き段ボール") -
      (
        v(r,"福岡入庫破損") +
        v(r,"福岡返品（JP都合）") +
        v(r,"福岡代替戻り（倉庫都合）") +
        v(r,"不具合品（福岡倉庫）") +
        v(r,"倉庫内破損（福岡倉庫）")
      ) : null;

    const ryugasaki = useRyugasaki ?
      v(r,"龍ケ崎空き段ボール") -
      (
        v(r,"龍ケ崎入庫破損") +
        v(r,"龍ケ崎返品") +
        v(r,"不具合品（龍ケ崎倉庫）") +
        v(r,"倉庫内破損（龍ケ崎倉庫）")
      ) : null;

    const hokkaido = useHokkaido ?
      v(r,"北海道空き段ボール") -
      (
        v(r,"北海道入庫破損") +
        v(r,"北海道返品（JP都合）") +
        v(r,"北海道代替戻り（倉庫都合）") +
        v(r,"不具合品（北海道倉庫）") +
        v(r,"倉庫内破損（北海道倉庫）")
      ) : null;

    // ===== 表示用セル =====
    const cell = (val, enabled) => {
      if (!enabled) return `<td class="gray">―</td>`;

      const shortage = Math.max(0, 2 - val);
      let cls = "";
      if (val <= 0) cls = "need-red";
      else if (val === 1) cls = "need-orange";

      return `<td class="${cls}">${val}${shortage > 0 ? ` (${shortage})` : ""}</td>`;
    };

    // ===== 発注必要がある行だけ表示 =====
    if (
      [tokyo, osaka, nagoya, fukuoka, ryugasaki, hokkaido]
        .some(v => v !== null && v <= 1)
    ) {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${name}</td>
        ${cell(tokyo, useTokyo)}
        ${cell(osaka, useOsaka)}
        ${cell(nagoya, useNagoya)}
        ${cell(fukuoka, useFukuoka)}
        ${cell(ryugasaki, useRyugasaki)}
        ${cell(hokkaido, useHokkaido)}
      `;
      tbody.appendChild(tr);
    }
  }
}
</script>

</body>
</html>
