<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>空箱発注チェック</title>

<style>
body {
  font-family: Arial, sans-serif;
  padding: 20px;
}

table {
  border-collapse: collapse;
  margin-top: 20px;
  width: 100%;
}

th, td {
  border: 1px solid #ccc;
  padding: 6px 8px;
  text-align: center;
}

th {
  background: #f0f0f0;
}

.need-red {
  background: #ffe5e5;
  color: #b00000;
  font-weight: bold;
}

.need-orange {
  background: #fff3cd;
  color: #8a6d3b;
  font-weight: bold;
}

.need-blue {
  background: #e6f2ff;
  color: #004a99;
  font-weight: bold;
}

.gray {
  background: #eee;
  color: #999;
}
</style>
</head>

<body>

<h2>空箱発注チェック</h2>

<label>
  良品判定数量：
  <input type="number" id="goodLimit" value="5" min="0">
</label>
<br><br>

<input type="file" id="csvFile" accept=".csv">

<table id="result">
  <thead>
    <tr>
      <th>商品名</th>
      <th>東京</th>
      <th>大阪</th>
      <th>名古屋</th>
      <th>福岡</th>
      <th>龍ヶ崎</th>
      <th>北海道</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<script>
const fileInput = document.getElementById("csvFile");
const tbody = document.querySelector("#result tbody");
const goodLimitInput = document.getElementById("goodLimit");

const norm = s => s.replace(/\s/g, "").trim();

fileInput.addEventListener("change", e => {
  const file = e.target.files[0];
  if (!file) return;

  const reader = new FileReader();
  reader.onload = () => parseCSV(reader.result);
  reader.readAsText(file, "Shift_JIS");
});

function parseCSV(text) {
  tbody.innerHTML = "";

  const goodLimit = Number(goodLimitInput.value);

  const rows = text.trim().split(/\r?\n/).map(r => r.split(","));
  const headers = rows[0];

  const idx = {};
  headers.forEach((h, i) => idx[norm(h)] = i);

  const v = (row, name) => {
    const i = idx[norm(name)];
    return i === undefined ? 0 : Number(row[i] || 0);
  };

  for (let i = 1; i < rows.length; i++) {
    const r = rows[i];
    const name = r[idx[norm("商品名")]];
    if (!name) continue;

    const areaText = (r[r.length - 1] || "").trim();

    const areas = {
      tokyo:     areaText.includes("東"),
      osaka:     areaText.includes("大"),
      nagoya:    areaText.includes("名"),
      fukuoka:   areaText.includes("福"),
      ryugasaki: areaText.includes("龍"),
      hokkaido:  areaText.includes("北")
    };

    const checkReplace = (enabled, good, empty, bads) => {
      if (!enabled) return false;
      return (
        good <= goodLimit &&
        empty >= 1 &&
        bads.every(v => v >= 1)
      );
    };

    const replace = {
      tokyo: checkReplace(
        areas.tokyo,
        v(r,"東京良品"),
        v(r,"東京空き段ボール"),
        [
          v(r,"東京入庫破損"),
          v(r,"東京返品（JP都合）"),
          v(r,"東京代替戻り（ダイワ都合）"),
          v(r,"不具合品（東京倉庫）"),
          v(r,"倉庫内破損（東京倉庫）")
        ]
      ),
      osaka: checkReplace(
        areas.osaka,
        v(r,"新大阪良品"),
        v(r,"新大阪空き段ボール"),

